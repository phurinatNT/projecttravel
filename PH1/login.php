<?php session_start(); require 'includes/db.php'; require 'includes/functions.php'; $error=''; if($_SERVER['REQUEST_METHOD']==='POST'){ $username=trim($_POST['username']); $password=$_POST['password']; $stmt=$conn->prepare('SELECT id,username,password,role FROM users WHERE username=? LIMIT 1'); $stmt->bind_param('s',$username); $stmt->execute(); $res=$stmt->get_result(); if($res && $user=$res->fetch_assoc()){ $hash=$user['password']; if(password_verify($password,$hash)){ $_SESSION['username']=$user['username']; $_SESSION['role']=$user['role']; header('Location:index.php'); exit(); } if(md5($password)===$hash){ $new=password_hash($password,PASSWORD_DEFAULT); $u=$conn->prepare('UPDATE users SET password=? WHERE id=?'); $u->bind_param('si',$new,$user['id']); $u->execute(); $_SESSION['username']=$user['username']; $_SESSION['role']=$user['role']; header('Location:index.php'); exit(); } $error='ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'; } else $error='ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'; } require 'includes/header.php'; ?>
<div class="card" style="max-width:520px;margin:18px auto"><h3>เข้าสู่ระบบ</h3><?php if($error) echo '<p style="color:#c0392b">'.e($error).'</p>'; ?><form method="post"><input name="username" required placeholder="ชื่อผู้ใช้"><br><br><input type="password" name="password" required placeholder="รหัสผ่าน"><br><br><button class="btn" type="submit">เข้าสู่ระบบ</button></form></div><?php require 'includes/footer.php'; ?>